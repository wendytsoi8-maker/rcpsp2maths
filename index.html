<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>小二立體圖形選擇平台</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --text:#eef2ff; --muted:#b7c0ff; --btn:#2a3cff; --danger:#ff3b3b; }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background: radial-gradient(1200px 800px at 30% 10%, #1a2457 0%, var(--bg) 60%);
      color: var(--text);
    }
    header { padding: 18px 16px 8px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .sub { margin: 0; color: var(--muted); font-size: 14px; line-height: 1.4; }

    .wrap { max-width: 1100px; margin: 0 auto; padding: 12px 16px 24px; display: grid; grid-template-columns: 360px 1fr; gap: 14px; }
    @media (max-width: 920px) { .wrap { grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .row { display:flex; gap:10px; align-items:center; margin: 10px 0; flex-wrap: wrap; }
    label { font-size: 14px; color: var(--muted); min-width: 92px; }
    select {
      flex: 1;
      min-width: 180px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(10,14,28,0.65);
      color: var(--text);
      outline: none;
    }
    .btns { display:flex; gap:10px; margin-top: 12px; }
    button {
      flex:1;
      border: none;
      padding: 11px 12px;
      border-radius: 12px;
      background: var(--btn);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform .06s ease;
    }
    button:active { transform: translateY(1px); }
    button.secondary {
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      font-weight: 700;
    }
    .hint { margin-top: 10px; font-size: 13px; color: var(--muted); line-height: 1.5; }
    .warn { margin-top: 10px; font-size: 13px; color: #ffd1d1; background: rgba(255,59,59,0.12); border: 1px solid rgba(255,59,59,0.25); padding: 10px 12px; border-radius: 12px; display:none; }

    .viewerTop { display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; }
    .nameBox { padding: 10px 12px; border-radius: 12px; border:1px solid rgba(255,255,255,0.14); background: rgba(10,14,28,0.55); min-height: 44px; }
    .nameTitle { font-size: 13px; color: var(--muted); margin-bottom: 4px; }
    .shapeName { font-size: 18px; font-weight: 800; letter-spacing: .2px; }

    #canvasWrap { margin-top: 12px; border-radius: 14px; overflow:hidden; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.25); }
    canvas { display:block; width: 100%; height: 520px; }
    .footerNote { margin-top: 10px; color: var(--muted); font-size: 12px; line-height: 1.5; }
    .kbd { padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>小二立體圖形選擇平台</h1>
    <p class="sub">流程：先選擇「錐／柱／球」→ 再選擇「有沒有曲面」→ 再選擇「有多少個面（平面）」→ 按「確定」顯示名稱與 3D 圖。</p>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <label for="typeSel">立體類別</label>
        <select id="typeSel">
          <option value="prism">柱</option>
          <option value="pyramid">錐</option>
          <option value="sphere">球</option>
        </select>
      </div>

      <div class="row">
        <label for="curveSel">曲面</label>
        <select id="curveSel">
          <option value="no">沒有曲面</option>
          <option value="yes">有曲面</option>
        </select>
      </div>

      <div class="row">
        <label for="facesSel">面（平面）</label>
        <select id="facesSel"></select>
      </div>

      <div class="btns">
        <button id="okBtn">確定</button>
        <button id="resetBtn" class="secondary">重設</button>
      </div>

      <div id="warnBox" class="warn"></div>

      <div class="hint">
        <b>提示（教學用定義）：</b><br/>
        「面」= 平面（不計曲面）<br/>
        例如：圓柱有 <b>2</b> 個面 + 1 個曲面；圓錐有 <b>1</b> 個面 + 1 個曲面；球有 <b>0</b> 個面 + 1 個曲面。
      </div>

      <div class="footerNote">
        操作：用滑鼠/手指拖曳可旋轉，滾輪可縮放。<br/>
        （如學生用平板）可用手指拖拉旋轉。<br/>
        3D 由程式即時生成，無需外部圖片檔。
      </div>
    </section>

    <section class="card">
      <div class="viewerTop">
        <div class="nameBox" style="flex:1;">
          <div class="nameTitle">立體圖形名稱</div>
          <div id="shapeName" class="shapeName">（尚未選擇）</div>
        </div>
        <div class="nameBox" style="width: 240px;">
          <div class="nameTitle">小提示</div>
          <div style="font-size:13px;color:var(--muted);line-height:1.4;">
            拖曳旋轉<br/>
            滾輪縮放<br/>
            右鍵拖曳平移
          </div>
        </div>
      </div>

      <div id="canvasWrap">
        <canvas id="c"></canvas>
      </div>
      <div class="footerNote">
        若顯示空白：請確認 GitHub Pages 網址使用 <span class="kbd">https</span>，並用較新版本瀏覽器開啟。
      </div>
    </section>
  </main>

  <!-- Three.js（ESM） + OrbitControls（ESM） -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";

    // ====== UI ======
    const typeSel = document.getElementById("typeSel");
    const curveSel = document.getElementById("curveSel");
    const facesSel = document.getElementById("facesSel");
    const okBtn = document.getElementById("okBtn");
    const resetBtn = document.getElementById("resetBtn");
    const warnBox = document.getElementById("warnBox");
    const shapeNameEl = document.getElementById("shapeName");

    function showWarn(msg) {
      warnBox.style.display = "block";
      warnBox.textContent = msg;
    }
    function clearWarn() {
      warnBox.style.display = "none";
      warnBox.textContent = "";
    }

    // 依「類別/曲面」更新可選 faces（平面數）
    function setFacesOptions(values, selected = null) {
      facesSel.innerHTML = "";
      for (const v of values) {
        const opt = document.createElement("option");
        opt.value = String(v);
        opt.textContent = String(v);
        facesSel.appendChild(opt);
      }
      if (selected !== null) facesSel.value = String(selected);
    }

    function refreshOptions() {
      clearWarn();
      const type = typeSel.value;
      const curve = curveSel.value;

      // 規則（面=平面）：
      // n角柱：面 = n + 2（n=3..10）=> 5..12（無曲面）
      // n角錐：面 = n + 1（n=3..10）=> 4..11（無曲面）
      // 圓柱：面=2 + 曲面（有曲面）
      // 圓錐：面=1 + 曲面（有曲面）
      // 球：面=0 + 曲面（有曲面）
      if (type === "sphere") {
        curveSel.value = "yes";
        curveSel.disabled = true;
        setFacesOptions([0], 0);
        facesSel.disabled = true;
        return;
      }
      curveSel.disabled = false;
      facesSel.disabled = false;

      if (type === "prism") {
        if (curve === "no") {
          setFacesOptions([5,6,7,8,9,10,11,12], 5);
        } else {
          // 柱 + 有曲面 => 只可能係圓柱（面=2）
          setFacesOptions([2], 2);
        }
        return;
      }

      if (type === "pyramid") {
        if (curve === "no") {
          setFacesOptions([4,5,6,7,8,9,10,11], 4);
        } else {
          // 錐 + 有曲面 => 只可能係圓錐（面=1）
          setFacesOptions([1], 1);
        }
        return;
      }
    }

    typeSel.addEventListener("change", refreshOptions);
    curveSel.addEventListener("change", refreshOptions);

    resetBtn.addEventListener("click", () => {
      typeSel.value = "prism";
      curveSel.value = "no";
      curveSel.disabled = false;
      facesSel.disabled = false;
      shapeNameEl.textContent = "（尚未選擇）";
      clearWarn();
      refreshOptions();
      setShape(null);
    });

    // ====== Three.js Scene ======
    const canvas = document.getElementById("c");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x0b1020, 10, 40);

    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 200);
    camera.position.set(6, 4.5, 8);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.55));
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(6, 10, 6);
    scene.add(dir);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(50, 50);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x0f1733, roughness: 0.9, metalness: 0.0 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -2.2;
    ground.receiveShadow = false;
    scene.add(ground);

    // Helpers (subtle)
    const grid = new THREE.GridHelper(30, 30, 0x3340aa, 0x1c255c);
    grid.position.y = -2.19;
    grid.material.opacity = 0.25;
    grid.material.transparent = true;
    scene.add(grid);

    let currentGroup = null;

    function clearCurrent() {
      if (!currentGroup) return;
      scene.remove(currentGroup);
      currentGroup.traverse(obj => {
        if (obj.geometry) obj.geometry.dispose();
        if (obj.material) {
          if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
          else obj.material.dispose();
        }
      });
      currentGroup = null;
    }

    // 建立立體（用幾何即時生成：不靠外部圖片/模型檔）
    function buildSolid(spec) {
      // spec: { kind, n }
      const group = new THREE.Group();

      // 主體材質
      const mat = new THREE.MeshStandardMaterial({
        color: 0x9fb3ff,
        roughness: 0.45,
        metalness: 0.05
      });

      // 邊線（線框）
      const lineMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.65 });

      let geo;
      const radius = 2.2;
      const height = 4.2;

      if (!spec) {
        // 空（預設顯示一個淡淡方塊作 placeholder）
        geo = new THREE.BoxGeometry(3, 3, 3);
      } else if (spec.kind === "nPrism") {
        geo = new THREE.CylinderGeometry(radius, radius, height, spec.n, 1, false);
      } else if (spec.kind === "nPyramid") {
        geo = new THREE.CylinderGeometry(0, radius, height, spec.n, 1, false);
      } else if (spec.kind === "cylinder") {
        geo = new THREE.CylinderGeometry(radius, radius, height, 48, 1, false);
      } else if (spec.kind === "cone") {
        geo = new THREE.CylinderGeometry(0, radius, height, 64, 1, false);
      } else if (spec.kind === "sphere") {
        geo = new THREE.SphereGeometry(2.4, 48, 24);
      } else {
        geo = new THREE.BoxGeometry(3, 3, 3);
      }

      const mesh = new THREE.Mesh(geo, mat);
      group.add(mesh);

      // 線框（Edges）
      const edges = new THREE.EdgesGeometry(geo, 20);
      const wire = new THREE.LineSegments(edges, lineMat);
      group.add(wire);

      // 令物件更居中
      group.position.y = 0;

      return group;
    }

    function setShape(spec) {
      clearCurrent();
      currentGroup = buildSolid(spec);
      scene.add(currentGroup);

      // 根據物件大小自動調整鏡頭距離（簡單做法）
      controls.target.set(0, 0.2, 0);
      controls.update();
    }

    function resize() {
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width));
      const h = Math.max(1, Math.floor(rect.height));
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);

    function animate() {
      resize();
      if (currentGroup) currentGroup.rotation.y += 0.002; // 微微自轉，吸引注意
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    // 初始
    refreshOptions();
    setShape(null);
    animate();

    // ====== 判斷輸入 -> 立體名稱 + spec ======
    function getShapeFromSelection(type, curve, faces) {
      const f = Number(faces);

      // 球
      if (type === "sphere") {
        if (curve !== "yes" || f !== 0) return null;
        return { name: "球", spec: { kind: "sphere" } };
      }

      if (type === "prism") {
        if (curve === "yes") {
          if (f !== 2) return null;
          return { name: "圓柱", spec: { kind: "cylinder" } };
        } else {
          const n = f - 2; // n角柱 => 面=n+2
          if (n < 3 || n > 10) return null;
          return { name: `${toChineseNumber(n)}角柱`, spec: { kind: "nPrism", n } };
        }
      }

      if (type === "pyramid") {
        if (curve === "yes") {
          if (f !== 1) return null;
          return { name: "圓錐", spec: { kind: "cone" } };
        } else {
          const n = f - 1; // n角錐 => 面=n+1
          if (n < 3 || n > 10) return null;
          return { name: `${toChineseNumber(n)}角錐`, spec: { kind: "nPyramid", n } };
        }
      }

      return null;
    }

    function toChineseNumber(n) {
      const map = {3:"三",4:"四",5:"五",6:"六",7:"七",8:"八",9:"九",10:"十"};
      return map[n] ?? String(n);
    }

    okBtn.addEventListener("click", () => {
      clearWarn();
      const type = typeSel.value;
      const curve = curveSel.value;
      const faces = facesSel.value;

      const result = getShapeFromSelection(type, curve, faces);
      if (!result) {
        shapeNameEl.textContent = "（沒有符合的立體圖形）";
        showWarn("你選擇的組合未能對應到指定立體圖形。請再試一次：例如「柱＋有曲面＋2面」= 圓柱；「錐＋有曲面＋1面」= 圓錐；「球＋有曲面＋0面」= 球。");
        setShape(null);
        return;
      }

      // 先顯示名稱，再顯示 3D（做個小延遲更符合你要求）
      shapeNameEl.textContent = result.name;
      setShape(null);
      setTimeout(() => setShape(result.spec), 350);
    });
  </script>
</body>
</html>
